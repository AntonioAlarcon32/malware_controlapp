import sys
from PyQt5.QtWidgets import QApplication, QMainWindow
from PyQt5.QtCore import QTimer
from PyQt5.QtGui import QStandardItemModel, QStandardItem
from PyQt5 import uic
import socketio

class CounterApp(QMainWindow):
    def __init__(self):
        super().__init__()
        uic.loadUi('ControlMainMenu.ui', self)  # Load the UI

        # Initialize the model for the connected hosts table
        self.hostsModel = QStandardItemModel(self)
        self.ConnectedHostsTable.setModel(self.hostsModel)
        self.hostsModel.setHorizontalHeaderLabels(['IP Address', 'Time Since last ping (s)'])

        # Initialize the model for the logs list
        self.logsModel = QStandardItemModel(self)
        self.LogsList.setModel(self.logsModel)

        # Dictionary to keep track of timers for each IP
        self.ipTimerDict = {}

        # Timer to update the 'Time Connected' column
        self.timer = QTimer(self)
        self.timer.timeout.connect(self.updateTimers)
        self.timer.start(1000)  # Update every second

        self.initSocketIO()

    def initSocketIO(self):
        self.sio = socketio.Client()
        self.sio.on('connect', self.on_connect)
        self.sio.on('disconnect', self.on_disconnect)
        self.sio.on('new_ip_connection', self.on_new_ip_connection)
        self.sio.on('all_ips', self.on_all_ips_received)
        self.sio.on('reset_timer', self.on_reset_timer)
        self.sio.connect('http://127.0.0.1:3000')

    def on_connect(self):
        self.addLog("Connected to Socket.IO server")
        self.sio.emit('request_all_ips')  # Request all connected IPs

    def on_disconnect(self):
        self.addLog("Disconnected from Socket.IO server")

    def on_new_ip_connection(self, data):
        self.addNewIP(data['ip'])
        self.addLog(f"New IP connected: {data['ip']}")

    def on_reset_timer(self, data):
        self.resetTimerForIP(data['ip'])

    def on_all_ips_received(self, data):
        # Process the received data containing all IPs
        for ip, counts in data['ip_counts'].items():
            self.addNewIP(ip)
        self.addLog("Added IPs on opening")

    def addNewIP(self, ip_address):
        ipItem = QStandardItem(ip_address)
        timeItem = QStandardItem('0')  # Start the timer at 0 seconds
        self.hostsModel.appendRow([ipItem, timeItem])
        self.ipTimerDict[ip_address] = (timeItem, 0)

    def updateTimers(self):
        for ip, (item, time) in self.ipTimerDict.items():
            time += 1
            self.ipTimerDict[ip] = (item, time)
            item.setText(str(time))

    def addLog(self, message):
        logItem = QStandardItem(message)
        self.logsModel.appendRow(logItem)

    def resetTimerForIP(self, ip_address):
        if ip_address in self.ipTimerDict:
            item, _ = self.ipTimerDict[ip_address]
            self.ipTimerDict[ip_address] = (item, 0)
            item.setText('0')
            self.addLog(f"Timer reset for IP: {ip_address}")


if __name__ == '__main__':
    app = QApplication(sys.argv)
    ex = CounterApp()
    ex.show()
    sys.exit(app.exec_())
